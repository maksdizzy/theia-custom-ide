{"version":3,"file":"websocket-endpoint.js","sources":["../../src/backend/websocket-endpoint.ts"],"sourcesContent":["import { WebsocketEndpoint as TheiaWebsocketEndpoint } from '@theia/core/lib/node/messaging/websocket-endpoint';\nimport { injectable } from '@theia/core/shared/inversify';\nimport * as http from 'http';\nimport * as https from 'https';\nimport { Server, Socket } from 'socket.io';\n\n@injectable()\nexport class WebsocketEndpoint extends TheiaWebsocketEndpoint {\n    // Add cors for any origin\n    onStart(server: http.Server | https.Server): void {\n        const socketServer = new Server(server, {\n            pingInterval: this.checkAliveTimeout,\n            pingTimeout: this.checkAliveTimeout * 2,\n            maxHttpBufferSize: this.maxHttpBufferSize,\n            cors: {\n                origin: '*',\n                methods: ['GET', 'POST'],\n                credentials: true,\n            },\n        });\n\n        // Accept every namespace by using /.*/\n        socketServer.of(/.*/).on('connection', async(socket: Socket) => {\n            const request = socket.request;\n\n            // Socket.io strips the `origin` header of the incoming request\n            // We provide a `fix-origin` header in the `WebSocketConnectionProvider`\n            request.headers.origin = request.headers['fix-origin'] as string;\n\n            if (await this.allowConnect(socket.request)) {\n                await this.handleConnection(socket);\n                void this.messagingListener.onDidWebSocketUpgrade(socket.request, socket);\n            }\n            else {\n                socket.disconnect(true);\n            }\n        });\n    }\n}\n"],"names":["WebsocketEndpoint","TheiaWebsocketEndpoint","server","Server","socket","request","__decorateClass","injectable"],"mappings":"kWAOaA,QAAAA,kBAAN,cAAgCC,EAAAA,iBAAuB,CAE1D,QAAQC,EAA0C,CACzB,IAAIC,EAAAA,OAAOD,EAAQ,CACpC,aAAc,KAAK,kBACnB,YAAa,KAAK,kBAAoB,EACtC,kBAAmB,KAAK,kBACxB,KAAM,CACF,OAAQ,IACR,QAAS,CAAC,MAAO,MAAM,EACvB,YAAa,EAAA,CACjB,CACH,EAGY,GAAG,IAAI,EAAE,GAAG,aAAc,MAAME,GAAmB,CAC5D,MAAMC,EAAUD,EAAO,QAIvBC,EAAQ,QAAQ,OAASA,EAAQ,QAAQ,YAAY,EAEjD,MAAM,KAAK,aAAaD,EAAO,OAAO,GACtC,MAAM,KAAK,iBAAiBA,CAAM,EAC7B,KAAK,kBAAkB,sBAAsBA,EAAO,QAASA,CAAM,GAGxEA,EAAO,WAAW,EAAI,CAC1B,CACH,CAAA,CAET,EA/BaJ,QAAAA,kBAANM,EAAA,CADNC,EAAAA,WAAA,CAAW,EACCP,yBAAA"}